# Auth & PDF Report Implementation Plan

## Overview
Implement secure user authentication using Supabase (Email/Password) and a client-side PDF reporting feature that aggregates maintenance logs and invoice images. This transitions the app from a local-only/guest model to a user-centric model with cloud synchronization, and adds a key value export feature.

## Project Type
**MOBILE** (React Native / Expo)

## Success Criteria
1.  **Authentication**: Users can Sign Up, Sign In, and Sign Out using Email/Password.
2.  **Data Isolation**: User data is legally separated in Supabase using Row Level Security (RLS).
3.  **Sync**: WatermelonDB synchronizes only the authenticated user's data.
4.  **PDF Report**: App generates a PDF containing a structured maintenance summary (generated by AI) and appends full-page invoice images.
5.  **Clean Slate**: Local database is wiped upon new user login to ensure no data leakage.

## Tech Stack
*   **Auth**: Supabase Auth (Email/Password)
*   **Database**: WatermelonDB (Local) + Supabase (Remote/PostgreSQL)
*   **PDF**: `expo-print` (Generation), `expo-sharing` (Export)
*   **AI**: Gemini 1.5 Flash (via existing AIService)

## File Structure
```
mobile/src/
├── context/
│   └── AuthContext.tsx       # Auth State Management
├── screens/
│   ├── auth/                 # New Auth Screens
│   │   ├── LoginScreen.tsx
│   │   └── RegisterScreen.tsx
│   └── reports/              # New Report Screen
│       └── PDFPreviewScreen.tsx
├── services/
│   ├── AuthService.ts        # Supabase Auth wrapper
│   ├── PDFService.ts         # HTML Generation & Print
│   └── SyncService.ts        # Updated for RLS
```

## Task Breakdown

### Phase 1: Authentication & Sync (P0)

#### 1.1 Install & Setup Auth Dependencies
*   **Agent**: `mobile-developer`
*   **Skill**: `mobile-design`
*   **Input**: `package.json`
*   **Action**: Ensure Supabase client is correctly configured for Auth. Create `AuthContext` to manage session state.
*   **Output**: `AuthContext.tsx` providing `user`, `session`, `signIn`, `signOut`.
*   **Verify**: App compiles, Context is reachable.

#### 1.2 Implement Auth Screens
*   **Agent**: `mobile-developer`
*   **Skill**: `mobile-design`
*   **Input**: Figma/Mental Model (Simple, clean UI)
*   **Action**: Create `LoginScreen` and `RegisterScreen`. Connect to `AuthContext`.
*   **Output**: Functional login flows.
*   **Verify**: User can create an account and log in. Console logs session token.

#### 1.3 Update Database & Sync for RLS
*   **Agent**: `backend-specialist` (or mobile-developer wearing DB hat)
*   **Skill**: `database-design`
*   **Input**: `supabase_schema.sql`, `SyncService.ts`
*   **Action**:
    1.  Update SQL: Add `user_id` column to tables if missing (defaulting to auth.uid()).
    2.  Update SQL: Enable RLS policies `CHECK (auth.uid() = user_id)`.
    3.  Update `SyncService`: Ensure pulling pulls only user data.
    4.  Update WatermelonDB `schema.js`: Add `user_id` column? (Optional if purely server-side handled, but safer to have).
*   **Output**: RLS enabled tables. Sync pulling correct data.
*   **Verify**: Two different users see different data.

#### 1.4 Wipe on Login Strategy
*   **Agent**: `mobile-developer`
*   **Skill**: `mobile-design`
*   **Input**: `AuthContext`, `database.ts`
*   **Action**: Implement `unsafeResetDatabase()` trigger strictly when a *new* user logs in or on logout.
*   **Output**: Clean local DB on auth state change.
*   **Verify**: Logout -> Login as User B -> Local DB is empty of User A's data.

### Phase 2: PDF Reporting (P1)

#### 2.1 AI Summary Prompt
*   **Agent**: `backend-specialist` (AI Logic)
*   **Skill**: `api-patterns`
*   **Input**: `AIService.ts`
*   **Action**: Create `generateMaintenanceReport(logs)` method. Prompt Gemini to create a professional summary html snippet.
*   **Output**: HTML string of summary.
*   **Verify**: Gemini returns valid HTML summary.

#### 2.2 PDF Service & Generation
*   **Agent**: `mobile-developer`
*   **Skill**: `mobile-design`
*   **Input**: `MaintenanceLog[]`, `Document[]` (images)
*   **Action**:
    1.  Create `PDFService`.
    2.  Method `generateHTML(summary, images)`: Concatenates summary HTML + `<img>` tags for invoices (one per page via CSS `page-break-after`).
    3.  Method `createPDF()`: Calls `printToFileAsync`.
*   **Output**: PDF file URI.
*   **Verify**: PDF generated, images visible.

#### 2.3 Report UI Integration
*   **Agent**: `mobile-developer`
*   **Skill**: `mobile-design`
*   **Input**: `MaintenanceScreen` or `Dashboard`.
*   **Action**: Add "Export Report" button. Show loading state during AI gen + PDF print. Share result.
*   **Output**: End-to-end flow.
*   **Verify**: Click -> Wait -> Share Sheet -> PDF opens.

### Phase 3: Cleanup & Polish (P2)
*   **Task**: Remove any guest-mode logic or hardcoded "test" user IDs.
*   **Task**: Ensure "Loading" states are pretty (Spinner/Skeleton).

## Phase X: Verification
- [ ] **Lint**: `npm run lint` passes
- [ ] **Security**: RLS policies tested (User A cannot fetch User B data via Supabase Client).
- [ ] **Build**: `npx expo run:android` works without crashing.
- [ ] **Functional**:
    - [ ] Sign Up works
    - [ ] Login works
    - [ ] Logout clears DB
    - [ ] PDF contains AI summary
    - [ ] PDF contains Invoice Images
